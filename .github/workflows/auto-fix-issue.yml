name: Auto-Fix Issue with Claude Code

on:
  issues:
    types: [opened]

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Claude Code
        run: npm i -g @anthropic-ai/claude-code

      - name: Create feature branch
        run: |
          git config user.email "${{ secrets.GIT_EMAIL }}"
          git config user.name "${{ secrets.GIT_NAME }}"
          BRANCH_NAME="fix/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Claude Code prompt
        id: prompt
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          cat > /tmp/claude-prompt.txt << 'EOF'
You are an automated assistant tasked with fixing a GitHub issue in this repository.

## Issue Details
Title: ${{ github.event.issue.title }}
Issue #${{ github.event.issue.number }}

Description:
${{ github.event.issue.body }}

## Your Task
1. Analyze the issue and understand what needs to be fixed
2. Make necessary changes to the codebase or documentation
3. Commit your changes with a clear message referencing the issue
4. Create a pull request that addresses this issue

## Important
- Reference the issue number in your commit message and PR description
- Use conventional commit format: "fix: description (fixes #issue_number)"
- Make sure all changes are tested and working
- Keep changes focused and minimal for this issue

Please proceed with fixing this issue.
EOF
          echo "PROMPT_FILE=/tmp/claude-prompt.txt" >> $GITHUB_OUTPUT

      - name: Run Claude Code to fix issue
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BEDROCK_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BEDROCK_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-west-2
          AWS_PROFILE: bedrock
          CLAUDE_CODE_USE_BEDROCK: 1
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Read the prompt
          PROMPT=$(cat /tmp/claude-prompt.txt)

          # Run Claude Code in batch mode
          echo "$PROMPT" | claude sonnet --no-verify

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git add .
          git commit -m "fix: Resolve issue #${{ github.event.issue.number }}

This automated fix addresses the reported issue.

Fixes #${{ github.event.issue.number }}"
          git push origin "fix/issue-${{ github.event.issue.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const branch = `fix/issue-${issue_number}`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fix: Resolve issue #${issue_number}`,
              head: branch,
              base: 'main',
              body: `## Automated Fix

This pull request automatically addresses issue #${issue_number}.

The fix was generated by Claude Code analyzing the issue and making appropriate changes.

**Issue**: ${{ github.event.issue.title }}

Please review the changes and merge if they look correct.

Fixes #${issue_number}`
            });

            console.log(`Created PR #${pr.data.number}`);

            // Add a comment to the original issue linking to the PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `ü§ñ Automated fix in progress! Pull request #${pr.data.number} has been created with the proposed changes.`
            });

      - name: Comment if no changes
        if: steps.changes.outputs.HAS_CHANGES == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è Claude Code analysis complete, but no changes were necessary. The issue may already be resolved or requires manual intervention.`
            });
