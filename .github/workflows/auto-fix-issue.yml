name: Auto-Fix Issue with Claude Code

on:
  issues:
    types: [opened]

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Claude Code
        run: npm i -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config user.email "dirkpetersen@users.noreply.github.com"
          git config user.name "Automated Claude Code"

      - name: Create feature branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue context file
        env:
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          mkdir -p /tmp
          cat > /tmp/issue-context.txt <<EOF
          Issue #$ISSUE_NUM: $ISSUE_TITLE

          Description:
          $ISSUE_BODY
          EOF

      - name: Run Claude Code to fix issue
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BEDROCK_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BEDROCK_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-west-2
          CLAUDE_CODE_USE_BEDROCK: 1
        run: |
          cat > /tmp/fix-prompt.md <<'PROMPT_EOF'
          # Fix GitHub Issue

          Please analyze and fix the following issue:

          PROMPT_EOF
          cat /tmp/issue-context.txt >> /tmp/fix-prompt.md
          cat >> /tmp/fix-prompt.md <<'PROMPT_EOF'

          ## Your Task
          1. Analyze the issue
          2. Make necessary changes to fix it (use Edit tool to modify files)
          3. Keep changes minimal and focused
          4. Test your changes if possible

          When done, I will automatically commit and create a PR.
          PROMPT_EOF

          # Run Claude Code with stdin in fully automated mode
          cat /tmp/fix-prompt.md | claude --dangerously-skip-permissions

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git add -A
          git commit -m "fix: Resolve issue #${{ github.event.issue.number }}"
          git push origin "fix/issue-${{ github.event.issue.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          BRANCH="fix/issue-$ISSUE_NUM"

          # Create PR using gh CLI
          PR_URL=$(gh pr create \
            --repo dirkpetersen/dok \
            --head "$BRANCH" \
            --base main \
            --title "Fix: Resolve issue #$ISSUE_NUM" \
            --body "## Automated Fix

This PR automatically addresses issue #$ISSUE_NUM.

**Issue**: $ISSUE_TITLE

Please review and merge if the fix looks good.

Fixes #$ISSUE_NUM")

          echo "Created PR: $PR_URL"

          # Comment on the issue
          gh issue comment $ISSUE_NUM \
            --repo dirkpetersen/dok \
            --body "ü§ñ PR created with automated fix: $PR_URL - Please review!"

      - name: Comment if no changes
        if: steps.changes.outputs.HAS_CHANGES == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: "‚ö†Ô∏è No changes were needed. The issue may already be resolved or requires manual intervention."
            });
