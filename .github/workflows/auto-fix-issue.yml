name: Auto-Fix Issue with Claude Code

on:
  issues:
    types: [opened]

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Claude Code
        run: npm i -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config user.email "dirkpetersen@users.noreply.github.com"
          git config user.name "Automated Claude Code"

      - name: Create feature branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create prompt file with issue context
        run: |
          cat > /tmp/issue-context.txt << 'ISSUE_EOF'
Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

Description:
${{ github.event.issue.body }}
ISSUE_EOF

      - name: Run Claude Code to analyze and fix issue
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BEDROCK_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BEDROCK_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-west-2
          AWS_PROFILE: bedrock
          CLAUDE_CODE_USE_BEDROCK: 1
        run: |
          # Create a simple wrapper to run Claude Code
          cat > /tmp/fix-issue.sh << 'EOF'
          #!/bin/bash
          set -e

          ISSUE_NUM=$1
          REPO_DIR="."

          # Read issue context
          CONTEXT=$(cat /tmp/issue-context.txt)

          cat > /tmp/claude-prompt.md << PROMPT_EOF
          # Automated Issue Fix

          You are an AI assistant helping to fix GitHub issues in a documentation and tooling repository.

          $CONTEXT

          ## Your Task:
          1. Analyze the issue and understand what needs to be fixed
          2. Make necessary changes to resolve it (docs, code, scripts, configs)
          3. Keep changes minimal and focused on this issue

          ## After completing:
          - Commit your changes with message: "fix: Resolve issue #$ISSUE_NUM"
          - You will not create a PR; that will be done automatically

          Proceed with fixing this issue now.
          PROMPT_EOF

          # Execute claude code with the prompt
          cd "$REPO_DIR"
          claude /tmp/claude-prompt.md
          EOF

          chmod +x /tmp/fix-issue.sh
          /tmp/fix-issue.sh ${{ github.event.issue.number }}

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes if any
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git add -A
          git commit -m "fix: Resolve issue #${{ github.event.issue.number }}"
          git push origin "fix/issue-${{ github.event.issue.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const branch = `fix/issue-${issue_number}`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fix: Resolve issue #${issue_number}`,
              head: branch,
              base: 'main',
              body: `## Automated Fix

This pull request automatically addresses issue #${issue_number}.

The fix was generated by Claude Code analyzing the issue and making appropriate changes.

**Issue**: ${{ github.event.issue.title }}

Please review the changes and merge if they look correct.

Fixes #${issue_number}`
            });

            console.log(`Created PR #${pr.data.number}`);

            // Add a comment to the original issue linking to the PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `ü§ñ Automated fix in progress! Pull request #${pr.data.number} has been created with the proposed changes.`
            });

      - name: Comment if no changes
        if: steps.changes.outputs.HAS_CHANGES == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è Claude Code analysis complete, but no changes were necessary. The issue may already be resolved or requires manual intervention.`
            });
